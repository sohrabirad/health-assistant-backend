<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>دستیار هوش مصنوعی پویان</title>
  <style>
    /* استایل‌ها مشابه کد قبلی شما */
  </style>
</head>
<body>

<header id="headerContent">
  <div>دستیار هوش مصنوعی پویان (نسخه 1.07)</div>
  <select id="modelSelect" aria-label="انتخاب مدل هوش مصنوعی"></select>
</header>

<div id="tokenDisplay">توکن مصرفی (حدوداً): 0</div>

<div id="chat-container">
  <div id="chat" role="log" aria-live="polite" aria-relevant="additions"></div>
  <div id="loadingIndicator" aria-label="در حال بارگذاری..." role="status"></div>
</div>

<div id="inputArea">
  <textarea id="inputMsg" placeholder="پیام خود را بنویسید..." aria-label="متن پیام" rows="2" autocomplete="off"></textarea>
  <input type="file" id="fileInput" accept=".txt, .pdf" />
  <div>&nbsp;</div>
  <button id="sendBtn" disabled>ارسال</button>
  <button id="newChatBtn">گفتگوی جدید</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  const chatDiv = document.getElementById('chat');
  const inputMsg = document.getElementById('inputMsg');
  const sendBtn = document.getElementById('sendBtn');
  const loadingIndicator = document.getElementById('loadingIndicator');
  const modelSelect = document.getElementById('modelSelect');
  const tokenDisplay = document.getElementById('tokenDisplay');
  const newChatBtn = document.getElementById('newChatBtn');
  const apiUrl = "http://localhost:8080/chat";  // آدرس بک‌اند خود را وارد کنید

  // بارگذاری مدل‌ها
  const modelList = [
    "whisper-1",
    "gpt-4o-mini (پیش‌فرض)",
    "gpt-4o",
    "gpt-4.1-nano",
    "gpt-4.1-mini",
    "gpt-4.1",
    "o3-mini-high",
    "gpt-4o-audio-preview",
    "o3-mini",
    "o3",
    "o3-mini-low",
    "o1",
    "o1-mini",
    "o4-mini",
    "gpt-4.5-preview",
    "chatgpt-4o-latest",
    "gemini-2.5-flash-preview-04-17",
    "gemini-2.5-pro-exp-03-25",
    "gemini-2.0-flash-lite-preview",
    "gemini-2.0-flash",
    "deepseek-reasoner",
    "deepseek-chat",
    "claude-3-7-sonnet-20250219-thinking",
    "claude-3-5-sonnet-20241022",
    "claude-3-7-sonnet-20250219"
  ];

  modelList.forEach(model => {
    const opt = document.createElement('option');
    opt.value = model;
    opt.textContent = model;
    if (model === 'gpt-4o-mini') opt.selected = true;
    modelSelect.appendChild(opt);
  });

  // ارسال پیام
  async function sendMessage() {
    const userText = inputMsg.value.trim();
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];

    if (!userText && !file) return;

    inputMsg.value = "";
    sendBtn.disabled = true;
    loadingIndicator.style.display = "block"; // نمایش چرخنده وسط چت

    const formData = new FormData();
    formData.append('model', modelSelect.value);
    if (file) formData.append('file', file);
    formData.append('conversation', JSON.stringify([{ role: "user", content: userText }]));

    try {
      const response = await fetch(apiUrl, {
        method: "POST",
        body: formData
      });

      if (!response.ok) throw new Error("خطا در پاسخ سرور");
      const data = await response.json();

      if (data.answer) {
        chatDiv.innerHTML += `<div><strong>مدل:</strong> ${data.answer}</div>`;
      } else {
        alert("پاسخ نامعتبر از سرور دریافت شد.");
      }
    } catch (e) {
      alert("خطا در ارتباط با سرور");
      console.error(e);
    } finally {
      sendBtn.disabled = false;
      loadingIndicator.style.display = "none";
    }
  }

  sendBtn.addEventListener('click', sendMessage);

  inputMsg.addEventListener('keydown', e => {
    if ((e.key === 'Enter' || e.keyCode === 13) && !e.shiftKey) {
      e.preventDefault();
      if (!sendBtn.disabled) sendMessage();
    }
  });

  newChatBtn.addEventListener('click', () => {
    if (confirm("آیا مطمئن هستید که می‌خواهید چت جدید شروع کنید؟")) {
      chatDiv.innerHTML = "";
      inputMsg.value = "";
    }
  });
</script>

</body>
</html>
